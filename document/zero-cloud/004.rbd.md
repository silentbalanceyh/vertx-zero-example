---
title: 执子之手：Ceph RBD
---

# 执子之手：Ceph RBD

> 死生契阔，与子成说。执子之手，与子偕老。——《诗经》

&ensp;&ensp;&ensp;&ensp;前边三个章节我们已经搭建好了K8S、Ceph、Harbor，基础环境已经有了，接下来这个章节就让K8S和Ceph联动起来，将Ceph作为K8S的底层存储引擎让二者协同工作，不论是之后的KubeSphere还是TiDB都可以直接使用本章配置的结果来访问底层存储。

![](./_image/2022-11-30/20221130092721.png)

&ensp;&ensp;&ensp;&ensp;K8S和Ceph集成有三种实现方式：

* Volumes存储卷
* PV/PVC持久化卷/持久化卷声明
* StorageClass动态存储，动态创建PV、PVC

&ensp;&ensp;&ensp;&ensp;Ceph支持K8S存储有两种类型：

* CephFS：文件系统
* Ceph RBD：块存储

> **注意**：一般写CephFS会将Ceph和FS连写，而RBD则中间加一空白来写！

## 1. ceph-csi

&ensp;&ensp;&ensp;&ensp;CSI[^1]全称Container Storage Interface，它是Ceph的一个插件，它的目的是定义行业标准“容器存储接口”，使存储供应商（SP）可以开发一个符合CSI标准的插件并使其能够在多个容器编排（CO）系统中工作。

&ensp;&ensp;&ensp;&ensp;本章K8S通过`ceph-csi`（csi plugin）来接入ceph存储（csi相关组件的分析以rbd为例进行分析），对csi系统结构、涉及的k8s对象和组件进行简单介绍，以及k8s对存储进行相关操作流程分析，存储相关操作包括**存储创建、存储扩容、存储挂载、解除存储、存储删除**操作。

### 1.1. 整体架构

> 图参考文档中内容重绘，PV/PVC/SC此处不解释其作用（烂大街的概念），下文主要围绕CSI部分。

![](./_image/2022-11-30/20221130113616.png)

#### VolumeAttachment组件

&ensp;&ensp;&ensp;&ensp;该组件记录了PV挂载的相关信息：**挂载到哪个Node节点、由哪个Volume Plugin来挂载**等。AD Controller会创建一个VolumeAttachment，而External-Attacher通过观察该VolumeAttachment，根据状态属性来执行存储的挂载、卸载操作。

#### CSINode

&ensp;&ensp;&ensp;&ensp;**CSINode**记录了`csi plugin`相关信息（**NodeId、DriverName、拓扑**），当Node Driver Register向kubelet注册一个csi plugin之后，会创建（更新）一个CSINode对象，记录csi plugin的相关信息。

#### Volume Plugin

&ensp;&ensp;&ensp;&ensp;该组件扩展各种存储类型的卷管理能力，实现第三方存储各种操作能力和K8S存储系统结合，并调用第三方存储的接口或命令，从而提供数据卷的创建/删除、attach/detach、mount/umount具体操作实现，可以认为是第三方存储代理人。

* **in-tree**：在K8S源码内部实现，和K8S一起发布、管理，更新迭代慢、灵活性差。
* **out-of-tree**：代码独立于K8S，由存储厂商实现，有`csi, flexvolume`两种实现。

#### CSI Plugin

&ensp;&ensp;&ensp;&ensp;`ceph-csi`就属于csi plugin，它主要分为ControllerServer和NodeServer，负责不同的存储操作。

#### External Plugin

&ensp;&ensp;&ensp;&ensp;主要包含四个子组件（参考图），它辅助csi plugin组件共同完成存储相关的操作。

|组件|作用|
|---|---|
|provisioner|Watch PVC对象，调用csi plugin创建存储，最终创建PV。|
|attacher|Watch VolumeAttachment对象，调用csi plugin做attach/dettach操作。|
|resizer|Watch PVC对象，调用csi plugin来做存储扩容。|
|snapshotter|创建快照。|

#### Node-Driver-Registrar

&ensp;&ensp;&ensp;&ensp;该组件负责实现csi plugin（NodeServer）的注册，让kubelet感知csi plugin的存在。

#### AD/PV Controller

&ensp;&ensp;&ensp;&ensp;PV Controller负责PV、PVC绑定和生命周期管理（创建/删除底层存储、创建/删除PV对象、PV和PVC对象状态变更）。

&ensp;&ensp;&ensp;&ensp;AD Controller全称Attachment/Detachment控制器，主要负责创建、删除VolumeAttachment对象，并调用volume plugin来做存储设备的Attach/Detach操作（将数据卷挂载到特定node节点上/从特定node节点上解除挂载），以及更新node.Status.VolumesAttached等。

> 关于这部分内容参考引用博文第一章，这里就不再做过多介绍，本章节的基本介绍只是起一个抛砖引玉的作用。

### 1.2. 

[^1]: [kubernetes ceph-csi分析目录导航（系列）](https://blog.csdn.net/kyle18826138721/article/details/115531669), 作者：[良凯尔](https://blog.csdn.net/kyle18826138721?type=blog)
